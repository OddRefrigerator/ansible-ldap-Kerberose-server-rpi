====================================================
Instructions
====================================================
KRB5 service:
----------------------------
sudo ./setupKRB5.sh
#sudo ./setupHost.sh
#sudo DEBIAN_FRONTEND=noninteractive apt install -y krb5-{kdc,admin-server,config,user,kdc-ldap} libsasl2-{dev,modules-gssapi-mit,modules} libpam-krb5 sssd-{krb5,krb5-common}
#sudo ./copyKRB5ConfigFiles.sh
#CHANGE THIS--> realm and password should be dynamically set from ENV variable or prog switch
#sudo kdb5_util create -s -r HOME.COM -P password123
#sudo systemctl restart krb5-kdc && sudo systemctl restart krb5-admin-server

LDAP service
----------------------------
export REALM="HOME.COM"
export krb5DBpw="password123"
export krb5admpw="password123"
export krb5Kdcldap="password123"
export krb5adminldap="password123"

sudo DEBIAN_FRONTEND=noninteractive apt install -y ldap-utils libnss-ldapd schema2ldif slapd
sudo ./copyLDAPConfigFiles.sh
sudo systemctl daemon-reload
sudo ./populateldap.sh
sudo systemctl restart krb5-kdc && sudo systemctl restart krb5-admin-server && sudo systemctl restart slapd
sudo ./installldapscripts.sh

On client:
----------
#sudo apt install krb5-{user,config,doc,k5tls} libpam-{krb5,ccreds} sssd
sudo  apt install libpam-krb5 libpam-ldap libnss-ldapd
sudo kadmin -p krbadmin 
sudo kadmin -q "addprinc -randkey host/auth.home.com"
sudo kadmin -q "ktadd host/auth.home.com"
sudo kadmin.local -q "addprinc -randkey host/oldlaptop.home.com"
sudo kadmin -q "ktadd host/oldlaptop.home.com"

====================================================
Scratch pad
====================================================
cn=krbContainer,dc=home,dc=com
cn=admin,dc=auth,dc=home,dc=com
cn=kerberos,cn=schema,cn=config
cn={4}kerberos,cn=schema,cn=config
uid=kdc-service,dc=home,dc=com
uid=kadmin-service,dc=home,dc=com

uid=kadmin-service,dc=home,dc=com

find . -type f -exec grep -H 'admin' {} \;
find / -type f -exec grep -H 'binddn' {} \;
find / -name slapd.conf

nano /usr/share/slapd/slapd.conf

journalctl --since "2020-05-16 17:51:00" -u systemd-sysuser

sudo dpkg-reconfigure krb5-config
sudo dpkg-reconfigure slapd
sudo dpkg-reconfigure libnss-ldapd
sudo pam-auth-update

sudo apt install -y ansible ansible-doc
scp -r ansible-kerberos-server/ pi@kdc.home.com:~
scp -r ansible-ldap-server/ pi@kdc.home.com:~

ssh-keygen -b 2048 -t rsa -C "pi key"
ssh-copy-id steve@steve-oldlaptop.home.com
ssh-copy-id pi@kdc.home.com

KRB5_TRACE=/dev/stdout kinit wronguser

kadmin.local -q "addprinc -randkey nfs/kdc.home.com@HOME.COM"
kadmin.local -q "addprinc -randkey nfs/192.168.1.10@HOME.COM"
kadmin.local -q "addprinc steve@HOME.COM"
kadmin.local -q "ktadd nfs/kdc.home.com@HOME.COM"
kadmin.local -q "ktadd nfs/192.168.1.10@HOME.COM"
kadmin.local -q "ktadd -k /etc/krb5.keytab pi@HOME.COM"
kadmin.local -q "ktadd krbtgt/HOME.COM@home.com"
kadmin.local -q "addprinc pi"
kadmin.local -q "listprincs"

sudo sh -c "echo -n 'password123' > /etc/libnss-ldap.secret"
sudo sh -c "echo -n 'password123' > /etc/ldapscripts/ldapscripts.passwd"
sudo nano /etc/ldapscripts/ldapscripts.conf
sudo cat /var/log/ldapscripts.log

kdb5_ldap_util -D cn=admin,dc=auth,dc=home,dc=com create -s -r HOME.COM -H ldapi:/// 
kdb5_ldap_util -D cn=admin,dc=auth,dc=home,dc=com create -subtrees dc=home,dc=com -r HOME.COM -s -H ldapi:///
kdb5_ldap_util -D uid=admin,dc=auth,dc=home,dc=com -w password123 stashsrvpw uid=kdc-service,dc=auth,dc=home,dc=com
kdb5_ldap_util -D cn=admin,dc=home,dc=com -w password123 -H ldap://auth.home.com create -subtrees dc=home,dc=com -P password123 -r HOME.COM -s
kdb5_ldap_util stashsrvpw -f /etc/krb5kdc/ldap.keyfile "uid=root,dc=home,dc=com"
kdb5_util create -s -r HOME.COM -P password123
kdb5_util destroy -f /var/lib/krb5kdc/principal

ldapadd -x -D cn=admin,dc=home,dc=com -w password123 -H ldap://auth.home.com -f krb5admin.ldif -c
ldapadd -x -D cn=admin,dc=home,dc=com -w password123 -H ldap://auth.home.com -f krb5perms.ldif -c

ldapwhoami -x -D cn=admin,dc=home,dc=com
ldapwhoami -H ldap://auth.home.com -x
ldapwhoami -Y EXTERNAL -H ldapi:///  -D "dc=home,dc=com"

ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f logging.ldif
ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f addkrb5Index.ldif
ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f krb5admin.ldif
ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f krb5admin.ldif
ldapmodify -H ldapi:/// -D "cn=admin,dc=home,dc=com" -f editGroups.ldif -W 
ldapmodify -H ldapi:/// -D "cn=admin,dc=home,dc=com" -f updatePW.ldif -W

ldapsearch -x -b "uid=steve,ou=people,dc=home,dc=com" -s sub "objectclass=*"
ldapsearch -x -LLL -b dc=home,dc=com 'uid=steve' cn gidNumber ou
ldapsearch -H ldap://auth.home.com -x -b "" -s base -LLL supportedSASLMechanisms
ldapsearch -H ldap://auth.home.com -x -b "dc=home,dc=home"
ldapsearch -H ldapi:/// -Y EXTERNAL -b "cn=config" "(olcRootDN=*)" olcSuffix olcRootDN olcRootPW -LLL -Q
ldapsearch -Y EXTERNAL -H ldapi:/// -b dc=home,dc=com
ldapsearch -Y EXTERNAL -H ldapi:/// -b dc=auth,dc=home,dc=com
ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=krbContainer,dc=home,dc=com
ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=kerberos,cn=schema,cn=config
ldapsearch -Y EXTERNAL -H ldapi:/// -b olcDatabase={1}mdb,cn=config
ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=config cn
ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config
ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=schema,cn=config -s base "objectclass=*"
ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b olcDatabase={1}hdb,cn=config
ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config '(olcDatabase={1}mdb)' olcAccess
ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=HOME.COM,cn=krbContainer,dc=home,dc=com

ldappasswd -x -D cn=admin,dc=home,dc=com -s password123 uid=kdc-service,dc=home,dc=com -w password123
ldappasswd -x -D cn=admin,dc=home,dc=com -s password123 uid=kadmin-service,dc=home,dc=com -w password123
ldappasswd -Y EXTERNAL -H ldapi:/// pi uid=pi,ou=Users,dc=home,dc=com

sudo ldapmodify -Q -Y EXTERNAL -H ldapi:/// <<EOF
dn: olcDatabase={1}mdb,cn=config
add: olcDbIndex
olcDbIndex: krbPrincipalName eq,pres,sub
EOF

dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema
olcObjectIdentifier

dn: cn={1}cosine,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: {1}cosine

[logging]
 default = FILE:/var/log/krb5-default.log
 kdc = FILE:/var/log/krb5-kdc.log
 admin_server = FILE:/var/log/krb5-admin.log

[logging]
 default = SYSLOG:DEBUG:DAEMON
 kdc = SYSLOG:DEBUG:DAEMON
 admin_server = SYSLOG:DEBUG:DAEMON

supportedSASLMechanisms: SCRAM-SHA-1
supportedSASLMechanisms: SCRAM-SHA-256
supportedSASLMechanisms: GS2-IAKERB
supportedSASLMechanisms: GS2-KRB5
supportedSASLMechanisms: GSS-SPNEGO
supportedSASLMechanisms: GSSAPI
supportedSASLMechanisms: DIGEST-MD5
supportedSASLMechanisms: NTLM
supportedSASLMechanisms: CRAM-MD5

String  X.500 AttributeType
------------------------------
CN      commonName
L       localityName
ST      stateOrProvinceName
O       organizationName
OU      organizationalUnitName
C       countryName
STREET  streetAddress
DC      domainComponent
UID     userid

openssl req -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -out /etc/ssl/ldap.crt -keyout /etc/ssl/private/ldap.pem